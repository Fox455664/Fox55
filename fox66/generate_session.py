# ํ์ผ๋ช: generate_session.py (ุงููุณุฎุฉ ุงููุทูุฑุฉ)

import asyncio
from telethon import TelegramClient

ACCOUNTS_FILE = "accounts.txt"

def save_account_to_file(session_string, api_id, api_hash):
    """
    ุชููู ูุฐู ุงูุฏุงูุฉ ุจุญูุธ ุจูุงูุงุช ุงูุญุณุงุจ ูู ููู accounts.txt
    ูุชุชุฃูุฏ ูู ุนุฏู ูุฌูุฏ ุชูุฑุงุฑ.
    """
    line_to_add = f"{session_string}|{api_id}|{api_hash}"
    
    # ูุฑุงุกุฉ ุงูููู ุฃููุงู ููุชุญูู ูู ูุฌูุฏ ุงูุญุณุงุจ
    try:
        with open(ACCOUNTS_FILE, "r") as f:
            for line in f:
                # ูุชุญูู ูู ุงูู api_id ูุชุฌูุจ ุชูุฑุงุฑ ููุณ ุงูุญุณุงุจ
                if str(api_id) in line:
                    print(f"โ๏ธ ุชุญุฐูุฑ: ุงูุญุณุงุจ ุตุงุญุจ ุงูู API ID ({api_id}) ููุฌูุฏ ุจุงููุนู ูู ุงูููู. ุชู ุงูุชุฎุทู.")
                    return False
    except FileNotFoundError:
        # ุฅุฐุง ูู ููู ุงูููู ููุฌูุฏูุงุ ุณูุชู ุฅูุดุงุคู
        pass

    # ุฅุถุงูุฉ ุงูุญุณุงุจ ุงูุฌุฏูุฏ ูู ุณุทุฑ ุฌุฏูุฏ
    with open(ACCOUNTS_FILE, "a") as f:
        f.write(line_to_add + "\n")
    print(f"โ ุชู ุญูุธ ุงูุญุณุงุจ ุจูุฌุงุญ ูู ููู '{ACCOUNTS_FILE}'.")
    return True

async def generate_and_save_session():
    """
    ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ ุงูุชู ุชุฏูุฑ ุนูููุฉ ุฅูุดุงุก ูุญูุธ ุฌูุณุฉ ูุงุญุฏุฉ.
    """
    print("\n--- โ ุฅุถุงูุฉ ุญุณุงุจ ุฌุฏูุฏ ---")
    try:
        api_id = int(input("๐ ุฃุฏุฎู ุงูู API ID ุงูุฎุงุต ุจุงูุญุณุงุจ ุงูุฌุฏูุฏ: "))
        api_hash = input("๐ ุฃุฏุฎู ุงูู API HASH ุงูุฎุงุต ุจุงูุญุณุงุจ ุงูุฌุฏูุฏ: ")
    except ValueError:
        print("โ ุฎุทุฃ: ุงูู API ID ูุฌุจ ุฃู ูููู ุฑูููุง. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.")
        return

    # ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ ูุชุฌูุจ ุฅูุดุงุก ูููุงุช .session ุบูุฑ ูุฑุบูุจ ูููุง
    async with TelegramClient(':memory:', api_id, api_hash) as client:
        try:
            # client.start() ูู ุงูุฐู ูุจุฏุฃ ุนูููุฉ ุชุณุฌูู ุงูุฏุฎูู ุงูุชูุงุนููุฉ
            # ุฅุฐุง ูุงู ุงูุญุณุงุจ ูุณุฌูุงู ุจุงููุนูุ ููู ูุทูุจ ุดูุฆูุง
            await client.start()
            
            # ุงูุชุฃูุฏ ูู ุฃู ุชุณุฌูู ุงูุฏุฎูู ุชู ุจูุฌุงุญ
            if not await client.is_user_authorized():
                print("โ ูุดู ุชุณุฌูู ุงูุฏุฎูู. ูุฏ ุชููู ุฃุฏุฎูุช ุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ.")
                # client.send_code_request() ู client.sign_in() ูููู ุงุณุชุฎุฏุงูููุง ููุง ููุฒูุฏ ูู ุงูุชุญูู
                # ูููู ุงูุทุฑููุฉ ุงูุชููุงุฆูุฉ ูู .start() ูุงููุฉ ููุนุธู ุงูุญุงูุงุช.
                return
                
            print("\nโ ุชู ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ!")
            
            # ุงูุญุตูู ุนูู session string
            session_string = client.session.save()
            
            # ุญูุธ ุงูุจูุงูุงุช ูู ุงูููู
            save_account_to_file(session_string, api_id, api_hash)

        except Exception as e:
            print(f"โ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุญุงููุฉ ุงูุงุชุตุงู ุฃู ุชุณุฌูู ุงูุฏุฎูู: {e}")

async def main():
    """
    ุงููุดุบู ุงูุฑุฆูุณู ุงูุฐู ูุณูุญ ุจุฅุถุงูุฉ ุญุณุงุจุงุช ูุชุนุฏุฏุฉ.
    """
    print("--- ๐ ูููุฏ ุงูุฌูุณุงุช ุงูุชููุงุฆู V2 ๐ ---")
    print(f"ุณูุชู ุญูุธ ุงูุญุณุงุจุงุช ุชููุงุฆูุงู ูู ููู '{ACCOUNTS_FILE}'.")
    
    while True:
        await generate_and_save_session()
        
        # ุณุคุงู ุงููุณุชุฎุฏู ุฅุฐุง ูุงู ูุฑูุฏ ุฅุถุงูุฉ ุญุณุงุจ ุขุฎุฑ
        another = input("\n๐ค ูู ุชุฑูุฏ ุฅุถุงูุฉ ุญุณุงุจ ุขุฎุฑุ (ุงูุชุจ 'ูุนู' ูููุชุงุจุนุฉ ุฃู ุงุถุบุท Enter ููุฎุฑูุฌ): ").lower()
        if another not in ['ูุนู', 'yes', 'y']:
            break
            
    print("\n๐ ุงูุชูุช ุนูููุฉ ุฅุถุงูุฉ ุงูุญุณุงุจุงุช. ููููู ุงูุขู ุชุดุบูู ุงูุจูุช ุงูุฑุฆูุณู.")

if __name__ == "__main__":
    # ูุฐุง ุงูุณุทุฑ ุถุฑูุฑู ูู ูููุฏูุฒ ูุชุฌูุจ ุฎุทุฃ ูุนูู ูุน asyncio
    if asyncio.get_event_loop().is_running():
         asyncio.get_event_loop().create_task(main())
    else:
         asyncio.run(main())